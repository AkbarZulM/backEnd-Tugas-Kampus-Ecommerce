// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum OrderStatus {
  DRAFT
  PENDING
  CONFIRMED
  ON_DELIVERY
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  BANK_TRANSFER
}

model Admin {
  id           String @id @default(uuid())
  name         String
  email        String @unique
  phone        String @unique
  passwordHash String
  role         String @default("staff") // "owner", "admin", "staff"

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("admins")
}

model Customer {
  id           String  @id @default(uuid())
  name         String
  email        String? @unique
  phone        String  @unique
  passwordHash String?

  // Relations
  orders    Order[]
  addresses Address[]

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  @@map("customers")
}

model Address {
  id         String  @id @default(uuid())
  customerId String  @map("customer_id")
  label      String  @default("Rumah")
  address    String
  city       String
  province   String
  postalCode String? @map("postal_code")
  latitude   Float?
  longitude  Float?
  isDefault  Boolean @default(false) @map("is_default")

  customer Customer @relation(fields: [customerId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([customerId])
  @@map("addresses")
}

model Product {
  id          String  @id @default(uuid())
  sku         String  @unique @map("sku") // Stock Keeping Unit
  name        String
  description String?
  price       Decimal @db.Decimal(12, 2)
  cost        Decimal @db.Decimal(12, 2) // Harga modal
  stock       Int     @default(0)
  category    String

  imageUrl String? @map("image_url")

  // Additional info
  isActive    Boolean @default(true) @map("is_active")
  isAvailable Boolean @default(true) @map("is_available")

  // Relations
  orderItems OrderItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([sku])
  @@index([category])
  @@index([isActive])
  @@map("products")
}

model Order {
  id          String @id @default(uuid())
  orderNumber String @unique @map("order_number")
  customerId  String @map("customer_id")

  // Order Details
  status       OrderStatus @default(PENDING)
  deliveryType String      @default("delivery") @map("delivery_type")
  notes        String?

  customerPhone String @map("customer_phone")

  // Pricing Breakdown 
  subtotal       Decimal @db.Decimal(12, 2)
  discountAmount Decimal @default(0) @map("discount_amount") @db.Decimal(12, 2)
  deliveryFee    Decimal @default(0) @map("delivery_fee") @db.Decimal(12, 2)
  totalAmount    Decimal @map("total_amount") @db.Decimal(12, 2)

  // Payment info
  paymentMethod PaymentMethod? @map("payment_method")

  // Timestamps
  orderDate DateTime @default(now()) @map("order_date")

  // Relations
  customer      Customer             @relation(fields: [customerId], references: [id])
  items         OrderItem[]
  payment       Payment?
  discount      OrderDiscount?
  statusHistory OrderStatusHistory[]
  delivery      Delivery?

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([customerId])
  @@index([orderNumber])
  @@index([status])
  @@index([orderDate])
  @@map("orders")
}

// Delivery tracking
model Delivery {
  id      String @id @default(uuid())
  orderId String @unique @map("order_id")

  // Driver info 
  driverName  String? @map("driver_name")
  driverPhone String? @map("driver_phone")

  order Order @relation(fields: [orderId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([orderId])
  @@map("deliveries")
}

model OrderItem {
  id          String  @id @default(uuid())
  orderId     String  @map("order_id")
  productId   String  @map("product_id")
  productName String  @map("product_name")
  quantity    Int     @default(1)
  unitPrice   Decimal @map("unit_price") @db.Decimal(12, 2)
  totalPrice  Decimal @map("total_price") @db.Decimal(12, 2)
  notes       String?

  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@index([orderId])
  @@map("order_items")
}

model Payment {
  id            String        @id @default(uuid())
  orderId       String        @unique @map("order_id")
  paymentMethod PaymentMethod @map("payment_method")
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status")
  amount        Decimal       @db.Decimal(12, 2)

  // Untuk transfer manual 
  bankName         String @map("bank_name")
  accountNumber    String @map("account_number")
  accountName      String @map("account_name")
  transferProofUrl String @map("transfer_proof_url")
  transferProofId  String @map("transfer_proof_id")

  completedAt DateTime? @map("completed_at")

  order Order @relation(fields: [orderId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([orderId])
  @@index([paymentStatus])
  @@map("payments")
}

model Discount {
  id          String  @id @default(uuid())
  code        String  @unique
  name        String
  description String?

  discountValue   Decimal  @map("discount_value") @db.Decimal(12, 2)
  maximumDiscount Decimal? @map("maximum_discount") @db.Decimal(12, 2)
  minimumPurchase Decimal  @default(0) @map("minimum_purchase") @db.Decimal(12, 2)

  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")
  isActive  Boolean  @default(true) @map("is_active")

  usedCount Int @default(0) @map("used_count")

  orderDiscounts OrderDiscount[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([code])
  @@map("discounts")
}

model OrderDiscount {
  id             String  @id @default(uuid())
  orderId        String  @unique @map("order_id")
  discountId     String? @map("discount_id")
  discountCode   String  @map("discount_code")
  discountAmount Decimal @map("discount_amount") @db.Decimal(12, 2)

  order    Order     @relation(fields: [orderId], references: [id])
  discount Discount? @relation(fields: [discountId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")

  @@index([orderId])
  @@map("order_discounts")
}

model OrderStatusHistory {
  id        String      @id @default(uuid())
  orderId   String      @map("order_id")
  status    OrderStatus
  notes     String?
  changedBy String?     @map("changed_by")

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([orderId])
  @@index([createdAt])
  @@map("order_status_history")
}
